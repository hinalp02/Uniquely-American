{"version":3,"file":"normalize.js","sources":["../lib/normalize.js"],"sourcesContent":["import _forEach from 'lodash-es/forEach'\nimport util from './util'\n/*\n * Breaks any long edges in the graph into short segments that span 1 layer\n * each. This operation is undoable with the denormalize function.\n *\n * Pre-conditions:\n *\n *    1. The input graph is a DAG.\n *    2. Each node in the graph has a \"rank\" property.\n *\n * Post-condition:\n *\n *    1. All edges in the graph have a length of 1.\n *    2. Dummy nodes are added where edges have been split into segments.\n *    3. The graph is augmented with a \"dummyChains\" attribute which contains\n *       the first dummy in each chain of dummy nodes produced.\n */\n\nfunction run (g) {\n  g.graph().dummyChains = []\n\n  _forEach(g.edges(), function (edge) {\n    normalizeEdge(g, edge)\n  })\n}\n\nfunction normalizeEdge (g, e) {\n  let v = e.v\n  let vRank = g.node(v).rank\n  const w = e.w\n  const wRank = g.node(w).rank\n  const name = e.name\n  const edgeLabel = g.edge(e)\n  const labelRank = edgeLabel.labelRank\n  if (wRank === vRank + 1) return\n  g.removeEdge(e)\n  let dummy\n  let attrs\n  let i\n\n  for (i = 0, ++vRank; vRank < wRank; ++i, ++vRank) {\n    edgeLabel.points = []\n    attrs = {\n      width: 0,\n      height: 0,\n      edgeLabel: edgeLabel,\n      edgeObj: e,\n      rank: vRank\n    }\n    dummy = util.addDummyNode(g, 'edge', attrs, '_d')\n\n    if (vRank === labelRank) {\n      attrs.width = edgeLabel.width\n      attrs.height = edgeLabel.height\n      attrs.dummy = 'edge-label'\n      attrs.labelpos = edgeLabel.labelpos\n    }\n\n    g.setEdge(v, dummy, {\n      weight: edgeLabel.weight\n    }, name)\n\n    if (i === 0) {\n      g.graph().dummyChains.push(dummy)\n    }\n\n    v = dummy\n  }\n\n  g.setEdge(v, w, {\n    weight: edgeLabel.weight\n  }, name)\n}\n\nfunction undo (g) {\n  _forEach(g.graph().dummyChains, function (v) {\n    let node = g.node(v)\n    const origLabel = node.edgeLabel\n    let w = null\n    g.setEdge(node.edgeObj, origLabel)\n\n    while (node.dummy) {\n      w = g.successors(v)[0]\n      g.removeNode(v)\n      origLabel.points.push({\n        x: node.x,\n        y: node.y\n      })\n\n      if (node.dummy === 'edge-label') {\n        origLabel.x = node.x\n        origLabel.y = node.y\n        origLabel.width = node.width\n        origLabel.height = node.height\n      }\n\n      v = w\n      node = g.node(v)\n    }\n  })\n}\n\nexport default {\n  run,\n  undo\n}\n"],"names":[],"mappings":"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"}