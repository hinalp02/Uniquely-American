{"version":3,"file":"sort-subgraph.js","sources":["../../lib/order/sort-subgraph.js"],"sourcesContent":["import _isUndefined from 'lodash-es/isUndefined'\nimport _flatten from 'lodash-es/flatten'\nimport _has from 'lodash-es/has'\nimport _forEach from 'lodash-es/forEach'\nimport _filter from 'lodash-es/filter'\nimport barycenter from './barycenter'\nimport resolveConflicts from './resolve-conflicts'\nimport sort from './sort'\n\nfunction sortSubgraph (g, v, cg, biasRight) {\n  let movable = g.children(v)\n  const node = g.node(v)\n  const bl = node ? node.borderLeft : undefined\n  const br = node ? node.borderRight : undefined\n  const subgraphs = {}\n\n  if (bl) {\n    movable = _filter(movable, function (w) {\n      return w !== bl && w !== br\n    })\n  }\n\n  const barycenters = barycenter(g, movable)\n\n  _forEach(barycenters, function (entry) {\n    if (g.children(entry.v).length) {\n      const subgraphResult = sortSubgraph(g, entry.v, cg, biasRight)\n      subgraphs[entry.v] = subgraphResult\n\n      if (_has(subgraphResult, 'barycenter')) {\n        mergeBarycenters(entry, subgraphResult)\n      }\n    }\n  })\n\n  const entries = resolveConflicts(barycenters, cg)\n  expandSubgraphs(entries, subgraphs)\n  const result = sort(entries, biasRight)\n\n  if (bl) {\n    result.vs = _flatten([bl, result.vs, br], true)\n\n    if (g.predecessors(bl).length) {\n      const blPred = g.node(g.predecessors(bl)[0])\n      const brPred = g.node(g.predecessors(br)[0])\n\n      if (!_has(result, 'barycenter')) {\n        result.barycenter = 0\n        result.weight = 0\n      }\n\n      result.barycenter = (result.barycenter * result.weight + blPred.order + brPred.order) / (result.weight + 2)\n      result.weight += 2\n    }\n  }\n\n  return result\n}\n\nfunction expandSubgraphs (entries, subgraphs) {\n  _forEach(entries, function (entry) {\n    entry.vs = _flatten(entry.vs.map(function (v) {\n      if (subgraphs[v]) {\n        return subgraphs[v].vs\n      }\n\n      return v\n    }), true)\n  })\n}\n\nfunction mergeBarycenters (target, other) {\n  if (!_isUndefined(target.barycenter)) {\n    target.barycenter = (target.barycenter * target.weight + other.barycenter * other.weight) / (target.weight + other.weight)\n    target.weight += other.weight\n  } else {\n    target.barycenter = other.barycenter\n    target.weight = other.weight\n  }\n}\n\nexport default sortSubgraph\n"],"names":[],"mappings":"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"}