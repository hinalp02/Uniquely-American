{"version":3,"file":"renderer.js","sources":["../../../src/components/leaflet-flow-map/renderer.ts"],"sourcesContent":["import { WebGLRenderer } from 'three/src/renderers/WebGLRenderer.js'\nimport { OrthographicCamera } from 'three/src/cameras/OrthographicCamera.js'\nimport { Scene } from 'three/src/scenes/Scene.js'\nimport { BufferGeometry } from 'three/src/core/BufferGeometry.js'\nimport { Points } from 'three/src/objects/Points.js'\nimport { BufferAttribute } from 'three/src/core/BufferAttribute.js'\nimport { InterleavedBufferAttribute } from 'three/src/core/InterleavedBufferAttribute.js'\nimport { ShaderMaterial } from 'three/src/materials/ShaderMaterial.js'\nimport { Color } from 'three/src/math/Color.js'\n\nimport { Particle } from './types'\n\nimport { vertex, fragment } from './shaders'\nimport { DEFAULT_POINT_RADIUS, getRadius, getColor } from './renderer-utils'\n\nexport class PointRenderer {\n  private width: number\n  private height: number\n  private devicePixelRatio = window.devicePixelRatio || 1\n  private containerNode: HTMLDivElement\n  private renderer: WebGLRenderer\n  private rendererCanvasElement: HTMLCanvasElement\n  private readonly camera: OrthographicCamera\n  private readonly scene: Scene\n\n  // Points\n  private pointsGeometry: BufferGeometry | undefined\n  private pointsBuffer: Points | undefined\n  private pointsPositions: BufferAttribute | InterleavedBufferAttribute | undefined\n  private pointsColors: BufferAttribute | InterleavedBufferAttribute | undefined\n  private pointsSizes: BufferAttribute | InterleavedBufferAttribute | undefined\n  private pointData: Particle[] = []\n\n  constructor (containerNode: HTMLDivElement, width: number, height: number, canvas?: HTMLCanvasElement) {\n    this.containerNode = containerNode\n    this.width = width\n    this.height = height\n\n    this.renderer = new WebGLRenderer({\n      antialias: true,\n      alpha: true,\n      canvas,\n    })\n    this.renderer.setSize(this.width, this.height)\n    this.renderer.setPixelRatio(this.devicePixelRatio)\n    this.renderer.setClearColor(0x00000000, 0)\n    this.renderer.clear()\n\n    if (!canvas) {\n      this.rendererCanvasElement = this.renderer.domElement\n      this.rendererCanvasElement.style.position = 'absolute'\n      this.rendererCanvasElement.style.top = '0'\n      this.containerNode.appendChild(this.rendererCanvasElement)\n    }\n\n    // Set up camera\n    this.camera = new OrthographicCamera(-0, this.width, -0, this.height, 0)\n\n    // Set up scene\n    this.scene = new Scene()\n\n    // Initialize geometry of points\n    this.initGeometry()\n  }\n\n  private initGeometry (): void {\n    const pointsMaterial = new ShaderMaterial({\n      uniforms: {\n        color: { value: new Color(0xffffff) },\n        size: { value: DEFAULT_POINT_RADIUS },\n      },\n      vertexShader: vertex,\n      fragmentShader: fragment,\n      transparent: true,\n    })\n    this.pointsGeometry = new BufferGeometry()\n    this.pointsBuffer = new Points(this.pointsGeometry, pointsMaterial)\n    this.pointsBuffer.frustumCulled = false\n    this.scene.add(this.pointsBuffer)\n    this.camera.lookAt(this.scene.position)\n  }\n\n  private initPointsAttributes (): void {\n    const numPoints = this.pointData.length\n    const pointsPositions = new Float32Array(numPoints * 3)\n    const pointsColors = new Float32Array(numPoints * 4)\n    const pointsSizes = new Float32Array(numPoints)\n    this.pointsGeometry?.setAttribute('position', new BufferAttribute(pointsPositions, 3))\n    this.pointsGeometry?.setAttribute('customColor', new BufferAttribute(pointsColors, 4))\n    this.pointsGeometry?.setAttribute('size', new BufferAttribute(pointsSizes, 1))\n    this.pointsPositions = this.pointsBuffer?.geometry.attributes.position\n    this.pointsColors = this.pointsBuffer?.geometry.attributes.customColor\n    this.pointsSizes = this.pointsBuffer?.geometry.attributes.size\n  }\n\n  public draw (): void {\n    this.renderer.render(this.scene, this.camera)\n  }\n\n  public update (points: Particle[]): void {\n    this.pointData = points\n\n    this.initPointsAttributes()\n    this.pointData.forEach((p, i) => {\n      const color = getColor(p.color)\n      const opacity = 1\n      const radius = getRadius(p.r, this.devicePixelRatio)\n      this.pointsColors?.setXYZW(i, color.r, color.g, color.b, opacity)\n      this.pointsSizes?.setX(i, radius)\n    })\n    const pointsColors = this.pointsColors as BufferAttribute\n    const pointsSizes = this.pointsSizes as BufferAttribute\n    pointsColors.needsUpdate = true\n    pointsSizes.needsUpdate = true\n\n    this.updatePointsPosition(points)\n  }\n\n  public updatePointsPosition (points: Particle[]): void {\n    points.forEach((p, i) => {\n      this.pointsPositions?.setXYZ(i, p.x, p.y, 0)\n    })\n    const pointsPosition = this.pointsPositions as BufferAttribute\n    pointsPosition.needsUpdate = true\n  }\n\n  public setSize (width: number, height: number): void {\n    this.width = width\n    this.height = height\n\n    this.renderer.setSize(this.width, this.height)\n    this.camera.right = this.width\n    this.camera.bottom = this.height\n    this.camera.updateProjectionMatrix()\n    this.renderer.render(this.scene, this.camera)\n  }\n\n  public getCanvasElement (): HTMLCanvasElement {\n    return this.rendererCanvasElement\n  }\n\n  public destroy (): void {\n    this.renderer.dispose()\n    this.renderer.domElement.remove()\n  }\n}\n"],"names":[],"mappings":"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"}