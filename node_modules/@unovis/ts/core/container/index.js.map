{"version":3,"file":"index.js","sources":["../../../src/core/container/index.ts"],"sourcesContent":["import { select, Selection } from 'd3-selection'\n\n// Types\nimport { Sizing } from 'types/component'\n\n// Utils\nimport { isEqual, clamp, merge } from 'utils/data'\nimport { ResizeObserver } from 'utils/resize-observer'\n\n// Config\nimport { ContainerDefaultConfig, ContainerConfigInterface } from './config'\n\nexport class ContainerCore {\n  public svg: Selection<SVGSVGElement, unknown, null, undefined>\n  public element: SVGSVGElement\n  public prevConfig: ContainerConfigInterface\n  public config: ContainerConfigInterface\n\n  protected _defaultConfig: ContainerConfigInterface = ContainerDefaultConfig\n  protected _container: HTMLElement\n  protected _requestedAnimationFrame: number\n  protected _isFirstRender = true\n  protected _resizeObserver: ResizeObserver | undefined\n  protected _svgDefs: Selection<SVGDefsElement, unknown, null, undefined>\n  private _containerSize: { width: number; height: number }\n\n  // eslint-disable-next-line @typescript-eslint/naming-convention\n  static DEFAULT_CONTAINER_HEIGHT = 300\n\n  constructor (element: HTMLElement) {\n    this._requestedAnimationFrame = null\n    this._container = element\n\n    // Setting `role` attribute to `image` to make the container accessible\n    const container = select(this._container)\n    container.attr('role', 'figure')\n\n    // Create SVG element for visualizations\n    this.svg = container.append('svg')\n      // We set `display` to `block` because inline elements have an invisible\n      //   inline space that adds 4px to the height of the container\n      .style('display', 'block')\n      .attr('xmlns', 'http://www.w3.org/2000/svg')\n      .attr('height', ContainerCore.DEFAULT_CONTAINER_HEIGHT) // Overriding default SVG height of 150\n      .attr('aria-hidden', true)\n\n    this._svgDefs = this.svg.append('defs')\n    this.element = this.svg.node()\n  }\n\n  public updateContainer<T extends ContainerConfigInterface> (config: T): void {\n    // eslint-disable-next-line @typescript-eslint/naming-convention\n    this.prevConfig = this.config\n    this.config = merge(this._defaultConfig, config)\n  }\n\n  // The `_preRender` step should be used to perform some actions before rendering.\n  // For example, calculating scales, setting component sizes, etc ...\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\n  protected _preRender (): void {}\n\n  // The `_render` step should be used to perform the actual rendering\n  protected _render (duration?: number): void {\n    const { config } = this\n\n    // Add `svgDefs` if provided in the config\n    if (config.svgDefs) {\n      this.svg.select('.svgDefs').remove()\n      this.svg.append('defs').attr('class', 'svgDefs').html(config.svgDefs)\n    }\n\n    // Apply the `aria-label` attribute\n    select(this._container)\n      .attr('aria-label', config.ariaLabel)\n\n    this._isFirstRender = false\n  }\n\n  // Warning: Some Containers (i.e. Single Container) may override this method, so if you introduce any changes here,\n  // make sure to check that other containers didn't break after them.\n  public render (duration = this.config.duration): void {\n    const width = this.config.width || this.containerWidth\n    const height = this.config.height || this.containerHeight\n\n    // We set SVG size in `render()` instead of `_render()`, because the size values in pixels will become\n    // available only in the next animation when being accessed via `element.clientWidth` and `element.clientHeight`,\n    // and we rely on those values when setting width and size of the components.\n    this.svg\n      .attr('width', width)\n      .attr('height', height)\n\n    // Set up Resize Observer. We do it in `render()` to capture container size change if it happened\n    // in the next animation frame after the initial `render` was called.\n    if (!this._resizeObserver) this._setUpResizeObserver()\n\n    // Schedule the actual rendering in the next frame\n    cancelAnimationFrame(this._requestedAnimationFrame)\n    this._requestedAnimationFrame = requestAnimationFrame(() => {\n      this._preRender()\n      this._render(duration)\n    })\n  }\n\n  get containerWidth (): number {\n    return this.config.width\n      ? this.element.clientWidth\n      : (this._container.clientWidth || this._container.getBoundingClientRect().width)\n  }\n\n  get containerHeight (): number {\n    return this.config.height\n      ? this.element.clientHeight\n      : (this._container.clientHeight || this._container.getBoundingClientRect().height || ContainerCore.DEFAULT_CONTAINER_HEIGHT)\n  }\n\n  get width (): number {\n    return clamp(this.containerWidth - this.config.margin.left - this.config.margin.right, 0, Number.POSITIVE_INFINITY)\n  }\n\n  get height (): number {\n    return clamp(this.containerHeight - this.config.margin.top - this.config.margin.bottom, 0, Number.POSITIVE_INFINITY)\n  }\n\n  protected _removeAllChildren (): void {\n    while (this.element.firstChild) {\n      this.element.removeChild(this.element.firstChild)\n    }\n  }\n\n  protected _onResize (): void {\n    const { config } = this\n    const redrawOnResize = config.sizing === Sizing.Fit || config.sizing === Sizing.FitWidth\n    if (redrawOnResize) this.render(0)\n  }\n\n  protected _setUpResizeObserver (): void {\n    if (this._resizeObserver) return\n    const containerRect = this._container.getBoundingClientRect()\n    this._containerSize = { width: containerRect.width, height: containerRect.height }\n\n    this._resizeObserver = new ResizeObserver((entries, observer) => {\n      const resizedContainerRect = this._container.getBoundingClientRect()\n      const resizedContainerSize = { width: resizedContainerRect.width, height: resizedContainerRect.height }\n      const hasSizeChanged = !isEqual(this._containerSize, resizedContainerSize)\n      // Do resize only if element is attached to the DOM\n      // will come in useful when some ancestor of container becomes detached\n      if (hasSizeChanged && resizedContainerSize.width && resizedContainerSize.height) {\n        this._containerSize = resizedContainerSize\n        this._onResize()\n      }\n    })\n    this._resizeObserver.observe(this._container)\n  }\n\n  public destroy (): void {\n    cancelAnimationFrame(this._requestedAnimationFrame)\n    this._resizeObserver?.disconnect()\n    this.svg.remove()\n  }\n}\n"],"names":[],"mappings":"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"}